/**
 * Solspace - Freeform
 *
 * @package		Solspace:Freeform
 * @author		Solspace DevTeam
 * @copyright	Copyright (c) 2008-2011, Solspace, Inc.
 * @link		http://solspace.com/docs/addon/c/Freeform/
 * @version		4.0.8.b1
 * @filesource	./system/expressionengine/third_party/freeform/
 *//**
 * Freeform - Composer CP JS
 *
 * @package		Solspace:Freeform
 * @author		Solspace DevTeam
 * @filesource	./themes/third_party/freeform/js/composer_cp.js
 */(function(e,t){"use strict";function Z(e,n,r){var s=12/r,o=[],u=r;while(u--)o.push("");var a=w({data:o,colspan:s.toString()});Q[n]=a;e.click(function(){var e=t(a).appendTo(i);nt(e,"row")});e.draggable({connectToSortable:"#composer_rows",forceHelperSize:!0,zIndex:1e3,helper:function(){$=!1;var e=t(this).clone().addClass("insert_element_width").height(t(this).outerHeight());return e}})}function et(e){e=e||!1;if(e===!1){t(".field_tag").each(function(){et(t(this))});return}e.draggable({connectToSortable:"#composer .connectedSortable",revert:!0,revertDuration:0,zIndex:1e3,helper:function(){return D({fieldLabel:e.text()})},start:function(e,t){t.helper.width(t.helper.outerWidth())}})}function tt(e,n,r){r=r||!1;var s=e.attr("data-element-id");K[s]=j({elementId:"nonfield_"+s,element:n});e.click(function(){var e=w({data:[K[s]],colspan:"12"}),n=t(e).appendTo(i);nt(n,"row")});et(e)}function nt(e,n){i.sortable("refresh");i.find("tr:not(.no_sort) td:not(.row_control_holder)").sortable({connectWith:"#composer .connectedSortable",items:".element_wrapper",handle:".element_cover",forcePlaceholderSize:!1,stop:function(e,n){var r=t(this),i=n.item;if(n.item.is(".field_tag")){var s=n.item.attr("data-field-name");i.replaceWith(at(s));setTimeout(function(){nt(r);rt()},0)}else if(n.item.is(".insert_element")){var o=n.item.attr("data-element-id");i.replaceWith(K[o]);setTimeout(function(){nt(r);rt()},0)}return n},start:function(e,t){t.helper.width()>400&&t.helper.width(400);t.helper.height(t.helper.css("height","").outerHeight());return t}});it()}function rt(){var e=r.find('.element_wrapper[data-element-id]:not([data-element-id^="nonfield"])'),n=t("#field_list .field_tag"),i={};n.removeClass("disabled");if(e.length>0){n.each(function(){var e=t(this);i[e.attr("data-field-name")]=e});e.each(function(){if(typeof i[t(this).attr("data-element-id")]=="undefined")return;i[t(this).attr("data-element-id")].addClass("disabled")})}}function it(){t(".row_control").each(function(){var e=t(this),n=e.parent().parent(),r=n.find("td").length;r==5?e.find(".row_add_column").addClass("disabled"):e.find(".row_add_column").removeClass("disabled");r==2?e.find(".row_remove_column").addClass("disabled"):e.find(".row_remove_column").removeClass("disabled")})}function st(e,n){var r=t("#field_edit_form"),i=r.attr("action"),s=n||!1;Freeform.initFieldEvents();Freeform.setUpChosenSelect(r);r.submit(function(e){e.preventDefault();var n=r.serializeArray();n.push({name:"include_field_data",value:"true"});n=t.param(n);t.fancybox.showActivity();t.post(i,n,function(e){t(".validation_error_holder").hide();if(!e.success){t.fancybox.hideActivity();Freeform.showValidationErrors(e.errors,r)}else s!==!1?ot(s,e,function(){t.fancybox.hideActivity();t.fancybox.close()}):ut(e,function(){t.fancybox.hideActivity();t.fancybox.close()})},"json");return!1});setTimeout(function(){t("#fancybox-wrap").stop().css({top:"50px"})},0)}function ot(e,n,r){if(n.success){var i=n.composerFieldData.fieldName,s=n.composerFieldData.fieldId;Freeform.composerFieldData[i]=n.composerFieldData;if(e!=i){t('.field_tag[data-field-name="'+e+'"]').attr("data-field-name",i);t('.element_wrapper[data-element-id="'+e+'"]').attr("data-element-id",i)}var o=t('.field_tag[data-field-name="'+i+'"]'),u=o.hasClass("disabled");o.replaceWith(H({fieldName:i,fieldLabel:n.composerFieldData.fieldLabel}));u&&t('.field_tag[data-field-name="'+i+'"]').addClass("disabled");t('.element_wrapper[data-element-id="'+i+'"]').replaceWith(at(i));nt();et()}typeof r=="function"&&r()}function ut(e,n){if(e.success){var r=e.composerFieldData.fieldName,i=e.composerFieldData.fieldId;Freeform.composerFieldData[r]=e.composerFieldData;Freeform.composerFieldIdList[r]=i;t("#field_list").append(H({fieldName:r,fieldLabel:e.composerFieldData.fieldLabel}));et()}typeof n=="function"&&n()}function at(e,t){return j({elementId:e,elementLabel:Freeform.composerFieldData[e].fieldLabel,element:Freeform.atob(Freeform.composerFieldData[e].fieldOutput),required:t||"no"})}function ft(e){e=e||!1;var n=t("#composer_rows tr"),r=[],i=[],s=!1,o=!1;J=!1;n.each(function(){var e=[],n=t(this),u=n.find("td:not(.row_control_holder)");if(n.hasClass("page_break_holder")){s=!0;o||(J=!0);r.push("page_break");o=!1;return}u.each(function(){var n=t(this),r=n.find(".element_wrapper"),s=[];r.each(function(){var e=t(this),n=e.attr("data-element-id"),r=e.attr("data-required"),u={},a="",f="";if(n.match(/^nonfield_/)){var l=n.replace("nonfield_","");u.type=n;if(l=="paragraph"){f=t.trim(e.find(".editable_paragraph .paragraph_content").html());f!==Freeform.composerLang.dblClickEdit?u.html=f:u.html=""}else if(l=="user_recipients"){a=t.trim(e.find(".editable_userrec .element_label:first").text());a!==Freeform.composerLang.notfyFriends?u.html=Freeform.formPrep(a):u.html=Freeform.composerLang.notfyFriends}else if(l=="dynamic_recipients"){var c=e.find(".editable_dynrec"),h=c.find("[data-recipients]"),p=c.find(".element_label"),d="",v="",m="select",g=0;if(h.length>0){var y=h.attr("data-recipients");if(typeof y=="string"){var b;try{b=JSON.parse(t.trim(y))}catch(w){b=!1}b&&(d=b)}var E=h.attr("data-type");if(E==="select"||E==="checks")m=E;var S=parseInt(h.attr("data-notification-id"),10);isNaN(S)||(g=S)}p.length>0&&p.text()&&(v=p.text());u.data=d;u.label=v;u.outputType=m;u.notificationId=g}else if(l=="submit"){o=!0;a=t.trim(e.find(".editable_submit button:first").text());a!==Freeform.composerLang.submit?u.html=Freeform.formPrep(a):u.html=Freeform.composerLang.submit}}else{u.type="field";u.fieldId=Freeform.composerFieldData[n].fieldId;u.required=r;i.push(u.fieldId)}s.push(u)});e.push(s)});r.push(e)});!s&&!o&&(J=!0);var u={rows:r,fields:i};return JSON.stringify(u)}function lt(e){return t("<div>"+e+"</div>").find(":not("+Freeform.allowedHtmlTags.join(", ")+")").removeTags().end().html()}function ct(e){var n=t("#dynrec_editor"),r=t(".type_value_label_holder:first",n);n.delegate(".freeform_delete_button","click",function(){t(this).parent().remove()});Freeform.autoDupeLastInput(r,"value_label_holder_input");Freeform.setUpChosenSelect(n);n.find(".dynrec_edit.finished").click(function(r){var i=t('[name="dynrec_type"]:checked').val()=="checks"?"checks":"select",s={};n.find(".value_label_holder_input").each(function(){var e=t(this),n=t.trim(e.find('[name^="list_value_holder_input"]:first').val()),r=t.trim(e.find('[name^="list_label_holder_input"]:first').val());n!==""&&r!==""&&(s[n]=r)});var o=t.trim(n.find('[name="dynrec_output_label"]').val()),u=n.find("#dynrec_notification_id").val();e.replaceWith(S({label:Freeform.formPrep(o),data:s,jsonData:Freeform.formPrep(JSON.stringify(s)),type:i,notificationId:u}));t.fancybox.close();r.preventDefault();return!1})}var n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,D,P,H,B,j,F,I,q,R,U,z,W,X,V,$=!1,J=!1,K={},Q={},G=[],Y={width:"90%",overlayOpacity:"0.75",onStart:function(){t("#fancybox-content").addClass("solspace_ui_wrapper")}};t(function(){_.templateSettings={evaluate:/<\{([\s\S]+?)\}>/g,interpolate:/<\{=([\s\S]+?)\}>/g,escape:/<\{-([\s\S]+?)\}>/g};s=t("#composer_wrapper");r=t("#composer",s);p=t("#single_row_button",s);o=t("#double_row_button",s);v=t("#triple_row_button",s);c=t("#quadruple_row_button",s);a=t("#title_button",s);l=t("#paragraph_button",s);f=t("#page_break_button",s);n=t("#captcha_button",s);u=t("#dynamic_recipients_button",s);m=t("#user_recipients_button",s);d=t("#submit_button_button",s);i=t("#composer_rows",s);h=t("#search_clear_button",s);y=t("#captcha_template").html();g=t("#column_template").html();E=t("#composer_row_template").html().replace("<{= columnTemplate }>",g);x=t("#dynrec_template").html();N=t("#edit_dynrec_template").html();k=t("#edit_paragraph_template").html();A=t("#edit_submit_button_template").html();M=t("#edit_userrec_template").html();P=t("#field_drag_template").html();P=t("#field_drag_template").html();B=t("#field_tag_template").html();F=t("#field_wrapper_template").html();I=t("#page_break_template").html();R=t("#paragraph_template").html();z=t("#submit_button_template").html();W=t("#textarea_template").html();V=t("#userrec_template").html();b=_.template(g);w=_.template(E);S=_.template(x);T=_.template(N);C=_.template(k);L=_.template(A);O=_.template(M);D=_.template(P);H=_.template(B);j=_.template(F);q=_.template(R);U=_.template(z);X=_.template(V);var e=w({data:[I],colspan:"12",notSortable:!1});Z(p,"single",1);Z(o,"double",2);Z(v,"triple",3);Z(c,"quadruple",4);f.click(function(){var n=t(e);n.addClass("page_break_holder no_sort").appendTo(i);nt(n,"row")});f.draggable({connectToSortable:"#composer_rows",forceHelperSize:!0,zIndex:1e3,helper:function(){$=!1;return t(this).clone().addClass("insert_element_width taller").css("text-align","center").height(t(this).outerHeight())}});tt(a,"<h2>"+Freeform.composerLang.formLabel+"</h2>");tt(n,y);tt(d,U());tt(l,q());tt(u,S());tt(m,X());r.delegate(".element_wrapper:has(.editable_paragraph)","dblclick",function(){var e=t(this),n=e.find(".editable_paragraph"),r=n.find(".paragraph_content").html(),i=Freeform.composerLang.dblClickEdit==t.trim(r)?"":t.trim(r);n.replaceWith(C({data:Freeform.formPrep(i)}));e.find(".element_cover").hide();e.find(".editor textarea").get(0).focus()});r.delegate(".element_wrapper .paragraph_edit.finished","click",function(){var e=t(this),n=e.closest(".element_wrapper"),r=n.find(".editor"),i=r.find("textarea:first"),s=t.trim(i.val()),o=Freeform.composerLang.dblClickEdit;if(s!==""&&s!==o){t.fancybox.showActivity();o=lt(Security.xssClean(s));t.fancybox.hideActivity()}r.replaceWith(q({data:o}));n.find(".element_cover").show()});r.delegate(".element_wrapper:has(.editable_submit)","dblclick",function(){var e=t(this),n=e.find(".editable_submit"),r=n.find(" button:first").text(),i=Freeform.composerLang.submit==t.trim(r)?"":t.trim(r);n.replaceWith(L({data:Freeform.formPrep(i)}));e.find(".element_cover").hide();e.find(".editor input").get(0).focus()});r.delegate(".element_wrapper .submit_edit.finished","click",function(){var e=t(this),n=e.closest(".element_wrapper"),r=n.find(".editor"),i=r.find('input[name="submit_edit"]:first'),s=t.trim(i.val()),o=Freeform.composerLang.submit;s!==""&&s!==o&&(o=Freeform.formPrep(s));r.replaceWith(U({data:o}));n.find(".element_cover").show()});r.delegate(".element_wrapper:has(.editable_userrec)","dblclick",function(){var e=t(this),n=e.find(".editable_userrec"),r=n.find(".element_label").text(),i=Freeform.composerLang.submit==t.trim(r)?"":t.trim(r);n.replaceWith(O({data:Freeform.formPrep(i)}));e.find(".element_cover").hide();e.find(".editor input").get(0).focus()});r.delegate(".element_wrapper .userrec_edit.finished","click",function(){var e=t(this),n=e.closest(".element_wrapper"),r=n.find(".editor"),i=r.find('input[name="userrec_edit"]:first'),s=t.trim(i.val()),o=Freeform.composerLang.notfyFriends;s!==""&&s!==o&&(o=Freeform.formPrep(s));r.replaceWith(X({data:o}));n.find(".element_cover").show()});r.delegate(".element_wrapper:has(.editable_dynrec)","dblclick",function(){var e=t(this),n=e.find(".editable_dynrec"),r=n.find("[data-recipients]"),i=n.find(".element_label"),s="",o="",u="select",a=0;if(r.length>0){var f=r.attr("data-recipients");if(typeof f=="string")try{s=JSON.parse(t.trim(f))}catch(l){s=""}var c=r.attr("data-type");if(c==="select"||c==="checks")u=c;var h=parseInt(r.attr("data-notification-id"),10);isNaN(h)||(a=h)}i.length>0&&i.text()&&(o=i.text());t.fancybox(_.extend(Y,{content:T({data:s,label:Freeform.formPrep(o),type:u,notificationId:a}),onComplete:function(){t(this).stop();t.fancybox.center();ct(n)}}))});t("#field_list").delegate(".field_tag","click",function(e){var n=t(this),r=n.attr("data-field-name");if(n.hasClass("disabled"))return!1;var s=t(w({data:[at(r)],colspan:"12"}));s.appendTo(i);n.addClass("disabled");nt(s,"row");e.preventDefault();return!1});t.get(Freeform.url.newField,function(e){Freeform.newFieldHtml=e;t("#new_field_button").fancybox(_.extend(Y,{content:Freeform.newFieldHtml,onComplete:function(){st(this)}}))});t("#field_list").delegate(".field_tag .freeform_edit_button","click",function(e){var n=t(this),r=n.parent().attr("data-field-name"),i=Freeform.composerFieldData[r];t.fancybox.showActivity();t.post(i.fieldEditUrl,function(e){t.fancybox(_.extend(Y,{content:e,onComplete:function(){st(this,r)}}))});e.preventDefault();return!1});i.sortable({handle:".row_control .freeform_drag_button",containment:"#composer > table tbody",axis:"y",items:"tr",forceHelperSize:!0,helper:function(e,n){n.children().each(function(){var e=t(this);e.width(e.outerWidth())});return n},receive:function(n,r){var i=t(this),s,o=i.data().sortable.currentItem;$=!0;if(r.item.is('[id$="_row_button"]')){var u=r.item.attr("id").replace("_row_button","");s=t(Q[u]);o.replaceWith(s);setTimeout(function(){nt(s,"row")},0)}else if(r.item.attr("data-element-id")=="page_break"){s=t(e);s.addClass("page_break_holder no_sort");o.replaceWith(s);setTimeout(function(){nt(s,"row")},0)}return r},over:function(e,t){$=!0}});r.droppable({accept:".row_button",drop:function(e,n){n.draggable.attr("id")?t("#"+n.draggable.attr("id")).click():$?$=!1:setTimeout(function(){if($)return;var e=/[a-z]+\_row\_button/g.exec(n.draggable.attr("class"));typeof e[0]!="undefined"&&t("#"+e[0]).click()},0)}});r.delegate(".element_control .element_require","click",function(e){var n=t(this);n.closest(".element_wrapper").attr("data-required","yes");e.preventDefault();return!1});r.delegate(".element_control .element_unrequire","click",function(e){var n=t(this);n.closest(".element_wrapper").attr("data-required","no");e.preventDefault();return!1});r.delegate(".element_control .element_delete","click",function(e){var n=t(this);n.closest(".element_wrapper").remove();rt();e.preventDefault();return!1});r.delegate(".row_control .row_delete, .page_break_holder .freeform_delete_button","click",function(e){var n=t(this);n.closest("tr").remove();rt();e.preventDefault();return!1});r.delegate(".row_control .row_add_column","click",function(e){var n=t(this),r=n.closest("tr"),i=r.find("td:not(.row_control_holder)");if(i.length<4){var s=12/(i.length+1);i.last().after(b({colspan:s}));i=r.find("td:not(.row_control_holder)");i.attr("colspan",s).css("width",Freeform.fractionToFloat(s,12,96)+"%")}it();nt();e.preventDefault();return!1});r.delegate(".row_control .row_remove_column","click",function(e){var n=t(this),r=n.closest("tr"),i=r.find("td:not(.row_control_holder)");if(i.length>1){var s=12/(i.length-1);i.last().remove();i=r.find("td:not(.row_control_holder)");i.attr("colspan",s).css("width",Freeform.fractionToFloat(s,12,96)+"%")}it();rt();e.preventDefault();return!1});et();var G=0,ot="",ut=function(){var e=t("#composer_template_select").val();t.fancybox(_.extend(_.clone(Y),{width:"95%",height:"95%",type:"iframe",href:Freeform.url.composerPreview+"&preview_id="+G+"&template_id="+e+"&cache_bust="+(new Date).getTime(),title:Freeform.composerLang.previewTitle+": "+Freeform.composerLang.formLabel,onComplete:function(){t(this).stop();t.fancybox.center()}}))},ht=function(e){t.fancybox.showActivity();e!==ot?t.post(Freeform.url.composerSave,{preview:"y",composer_data:e,XID:EE.XID||Freeform.XID},function(t){ot=e;G=t.composerId;ut()},"json"):ut()};t("#preview").click(function(e){var t=ft();J?Freeform.jQUIDialog({immediate:!0,cancel:Freeform.composerLang.cancel,cancelClick:function(){},ok:Freeform.composerLang.continueAnyway,okClick:function(){ht(t)},message:Freeform.composerLang.missingSubmits}):ht(t);e.preventDefault();return!1}).css("cursor","pointer");var pt=!1;t("#save_composer").submit(function(e){var n=ft();if(!pt&&J){Freeform.jQUIDialog({immediate:!0,cancel:Freeform.composerLang.cancel,cancelClick:function(){},ok:Freeform.composerLang.continueAnyway,okClick:function(){pt=!0;t("#save_composer").submit()},message:Freeform.composerLang.missingSubmits});e.preventDefault();return!1}t.fancybox.showActivity();t("#composer_save_data").val(n);t("#composer_template_id").val(t("#composer_template_select").val())}).css("cursor","pointer");t("#clear_all").click(function(){Freeform.jQUIDialog({immediate:!0,cancel:Freeform.composerLang.cancel,cancelClick:function(){},ok:Freeform.composerLang.ok,okClick:function(){r.find(".row_control .row_delete, .page_break_holder .freeform_delete_button").click()},message:Freeform.composerLang.clearAllWarn})});if(typeof Freeform.composerLayoutData.rows!="undefined"){var dt,vt,mt,gt,yt,bt,wt,Et,St,xt,Tt=Freeform.composerLayoutData.rows,Nt=1;for(dt=0,vt=Tt.length;dt<vt;dt++){if(Tt[dt]=="page_break"){f.click();Nt++;continue}wt=Tt[dt];St=[];for(mt=0,gt=wt.length;mt<gt;mt++){Et=wt[mt];xt="";for(yt=0,bt=Et.length;yt<bt;yt++)Et[yt].type=="nonfield_title"?xt+=K.title:Et[yt].type=="nonfield_paragraph"?Et[yt].html===""?xt+=K.paragraph:xt+=j({elementId:"nonfield_paragraph",element:q({data:Et[yt].html})}):Et[yt].type=="nonfield_user_recipients"?Et[yt].html===""?xt+=K.paragraph:xt+=j({elementId:"nonfield_user_recipients",element:X({data:Et[yt].html})}):Et[yt].type=="nonfield_dynamic_recipients"?Et[yt].html===""?xt+=K.dynrec:xt+=j({elementId:"nonfield_dynamic_recipients",element:S({jsonData:Freeform.formPrep(JSON.stringify(Et[yt].data)),data:Et[yt].data,label:Freeform.formPrep(Et[yt].label),type:Et[yt].outputType,notificationId:typeof Et[yt].notificationId!="undefined"?Et[yt].notificationId:0})}):Et[yt].type=="nonfield_captcha"?xt+=K.captcha:Et[yt].type=="nonfield_submit"?typeof Et[yt].html=="undefined"||Et[yt].html===""?xt+=K.submit:xt+=j({elementId:"nonfield_submit",element:U({data:Freeform.formPrep(Et[yt].html)})}):Et[yt].type=="field"&&typeof Et[yt].fieldId!="undefined"&&typeof Freeform.composerFieldIdList[Et[yt].fieldId]!="undefined"&&(xt+=at(Freeform.composerFieldIdList[Et[yt].fieldId],typeof Et[yt].required!="undefined"&&Et[yt].required=="yes"?"yes":"no"));St.push(xt)}var Ct=t(w({data:St,colspan:12/St.length})).appendTo(i);nt(Ct,"row");rt()}}else a.click();Freeform.elementSearch("#search_fields","#field_list .field_tag",".field_label","html");h.click(function(){t("#search_fields").val("").keyup();h.hide()}).hide();var kt=0;t("body").delegate("#search_fields","keyup",function(e){var n=t(this);clearTimeout(kt);kt=setTimeout(function(){t.trim(n.val())===""||n.attr("placeholder")&&n.val()==n.attr("placeholder")?h.hide():h.show()},100)})})})(window,jQuery);